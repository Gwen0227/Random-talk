---
import BlogCard from '@/components/BlogCard.astro'
import PageHead from '@/components/PageHead.astro'
import { SITE } from '@/consts'
import Layout from '@/layouts/Layout.astro'
import { getAllPosts } from '@/lib/data-utils'

const allPosts = await getAllPosts()
const postsPerPage = SITE.postsPerPage || 5
const initialPosts = allPosts.slice(0, postsPerPage)
const totalPages = Math.ceil(allPosts.length / postsPerPage)
---

<Layout class="max-w-3xl">
  <PageHead slot="head" title="Home" />
  
  <section class="rounded-lg border mb-8">
    <div class="flex flex-col space-y-1.5 p-6">
      <h3 class="text-3xl leading-none font-medium">er·u·dite</h3>
      <p class="text-muted-foreground text-sm">
        /ˈer(y)əˌdīt/ &bull; <span class="font-medium">adjective</span>
      </p>
    </div>
    <div class="p-6 pt-0">
      <p class="text-muted-foreground mb-2 text-sm">
        Welcome to my personal blog. This is a place where I share my thoughts and experiences.
      </p>
    </div>
  </section>

  <section class="flex flex-col gap-y-4">
    <h2 class="text-2xl font-medium">Latest posts</h2>
    
    <div 
      id="infinite-scroll-wrapper"
      data-current-page="1" 
      data-total-pages={totalPages}
      data-base-url={import.meta.env.BASE_URL}
    >
      <ul id="post-container" class="flex flex-col gap-y-4">
        {
          initialPosts.map((post) => (
            <li>
              <BlogCard entry={post} />
            </li>
          ))
        }
      </ul>

      <div id="scroll-sentinel" class="h-20 w-full flex justify-center items-center">
        <div id="loader" class="hidden text-sm text-muted-foreground animate-pulse">
          Loading more posts...
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  function setupInfiniteScroll() {
    const wrapper = document.getElementById('infinite-scroll-wrapper');
    const container = document.getElementById('post-container');
    const sentinel = document.getElementById('scroll-sentinel');
    const loader = document.getElementById('loader');

    if (!wrapper || !container || !sentinel) return;

    let currentPage = parseInt(wrapper.dataset.currentPage || '1');
    const totalPages = parseInt(wrapper.dataset.totalPages || '1');
    const baseUrl = wrapper.dataset.baseUrl === '/' ? '' : (wrapper.dataset.baseUrl || '');
    let isLoading = false;

    if (currentPage >= totalPages) {
      sentinel.style.display = 'none';
      return;
    }

    const observer = new IntersectionObserver(async (entries) => {
      if (entries[0].isIntersecting && !isLoading && currentPage < totalPages) {
        isLoading = true;
        currentPage++;
        loader?.classList.remove('hidden');

        try {
          // 修正：使用正確的子目錄路徑進行抓取
          const response = await fetch(`${baseUrl}/blog/${currentPage}`);
          if (!response.ok) throw new Error('Next page not found');
          
          const html = await response.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // 抓取下一頁中的文章列表
          const newPosts = doc.querySelectorAll('#post-container li');

          if (newPosts.length > 0 && container) {
            newPosts.forEach(post => {
              container.appendChild(post.cloneNode(true));
            });
          }

          if (currentPage >= totalPages) {
            observer.disconnect();
            sentinel.style.display = 'none';
          }
        } catch (error) {
          console.error('Error loading posts:', error);
          observer.disconnect();
        } finally {
          isLoading = false;
          loader?.classList.add('hidden');
        }
      }
    }, {
      rootMargin: '400px',
    });

    observer.observe(sentinel);
  }

  document.addEventListener('astro:page-load', setupInfiniteScroll);
</script>